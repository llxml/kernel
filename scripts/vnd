#!/bin/bash
set -e

VENDOR_DIR="vendor"
LIB_BASE="${LLXML_RUST_LIBS:-$HOME/dev/rust}"
WEB_LIB_BASE="${LLXML_WEB_LIBS:-$HOME/dev/web}"

usage() {
  cat <<EOF
vnd - vendor submodule manager

Usage:
  vnd init                      Create vendor/ directory with .gitkeep
  vnd add <type/name>           Add submodule from stable worktree
  vnd rm <name>                 Remove vendor/<name> submodule
  vnd pull [name]               Pull latest from stable (all or specific)
  vnd update [name]             Pull latest and stage the change (all or specific)
  vnd status [name]             Show ahead/behind vs stable (all or specific)
  vnd checkout <name> <ref>     Checkout specific commit/branch
  vnd ls                        List all vendor submodules
  vnd sync                      Sync submodule URLs after .gitmodules change

Environment:
  LLXML_RUST_LIBS   Rust library root (default: \$HOME/dev/rust)
  LLXML_WEB_LIBS    Web library root (default: \$HOME/dev/web)

Library locations:
  rust/<name>  -> \$LLXML_RUST_LIBS/<name>/stable
  web/<name>   -> \$LLXML_WEB_LIBS/<name>/stable

Examples:
  vnd add rust/sqlkit           # adds vendor/sqlkit from stable worktree
  vnd add web/jotai-developer-tools
  vnd update sqlkit             # pull + git add
  vnd status
  vnd checkout sqlkit abc123
EOF
}

get_lib_path() {
  local lib_path="$1"
  local lib_type="${lib_path%%/*}"
  local lib_name="${lib_path##*/}"
  
  case "$lib_type" in
    rust) echo "${LIB_BASE}/${lib_name}" ;;
    web)  echo "${WEB_LIB_BASE}/${lib_name}" ;;
    *)    echo "" ;;
  esac
}

cmd_init() {
  if [[ -f .gitmodules ]] && grep -q "\[submodule \"$VENDOR_DIR/" .gitmodules 2>/dev/null; then
    git submodule update --init --recursive "$VENDOR_DIR"
    echo "Initialized vendor submodules"
  else
    mkdir -p "$VENDOR_DIR"
    touch "$VENDOR_DIR/.gitkeep"
    git add "$VENDOR_DIR/.gitkeep"
    echo "Initialized $VENDOR_DIR/"
  fi
}

cmd_add() {
  local lib_path="$1"
  
  if [[ -z "$lib_path" ]]; then
    echo "Error: lib path required (e.g., rust/sqlkit)" >&2
    exit 1
  fi
  
  local lib_type="${lib_path%%/*}"
  local lib_name="${lib_path##*/}"
  local lib_dir=$(get_lib_path "$lib_path")
  
  if [[ -z "$lib_dir" ]]; then
    echo "Error: unknown lib type '$lib_type' (use rust/ or web/)" >&2
    exit 1
  fi
  
  local stable_path="${lib_dir}/stable"
  local lib_url="file://${stable_path}"
  local submodule_path="${VENDOR_DIR}/${lib_name}"
  
  if [[ ! -d "$stable_path" ]]; then
    echo "Error: ${stable_path} does not exist" >&2
    echo "Hint: Create stable worktree with:" >&2
    echo "  cd ${lib_dir}/main && git branch stable && git worktree add ../stable stable" >&2
    exit 1
  fi
  
  git submodule add "$lib_url" "$submodule_path"
  echo "Added $submodule_path -> $lib_url"
}

cmd_rm() {
  local name="$1"
  if [[ -z "$name" ]]; then
    echo "Error: submodule name required" >&2
    exit 1
  fi
  
  local submodule_path="${VENDOR_DIR}/${name}"
  
  git submodule deinit -f "$submodule_path"
  git rm -f "$submodule_path"
  rm -rf ".git/modules/${submodule_path}"
  echo "Removed $submodule_path"
}

cmd_pull() {
  local name="$1"
  
  if [[ -n "$name" ]]; then
    local submodule_path="${VENDOR_DIR}/${name}"
    if [[ ! -d "$submodule_path" ]]; then
      echo "Error: $submodule_path does not exist" >&2
      exit 1
    fi
    (cd "$submodule_path" && git fetch origin && git checkout origin/HEAD)
  else
    git submodule foreach 'git fetch origin && git checkout origin/HEAD'
  fi
}

cmd_update() {
  local name="$1"
  
  if [[ -n "$name" ]]; then
    local submodule_path="${VENDOR_DIR}/${name}"
    if [[ ! -d "$submodule_path" ]]; then
      echo "Error: $submodule_path does not exist" >&2
      exit 1
    fi
    (cd "$submodule_path" && git fetch origin && git checkout origin/HEAD)
    git add "$submodule_path"
    echo "Updated and staged $name"
  else
    git submodule foreach 'git fetch origin && git checkout origin/HEAD'
    git add "$VENDOR_DIR"
    echo "Updated and staged all vendor submodules"
  fi
}

cmd_status() {
  local name="$1"
  
  if [[ -n "$name" ]]; then
    _show_submodule_status "${VENDOR_DIR}/${name}"
  else
    for submodule in "$VENDOR_DIR"/*/; do
      [[ -d "$submodule" ]] && _show_submodule_status "${submodule%/}"
    done
  fi
}

_show_submodule_status() {
  local submodule_path="$1"
  local name="${submodule_path##*/}"
  
  local lib_url=$(git config --file .gitmodules --get "submodule.${submodule_path}.url" 2>/dev/null)
  if [[ -z "$lib_url" ]]; then
    echo "$name: not a submodule"
    return
  fi
  
  if [[ ! -d "$submodule_path/.git" && ! -f "$submodule_path/.git" ]]; then
    echo "$name: not initialized (run: git submodule update --init)"
    return
  fi
  
  local lib_path="${lib_url#file://}"
  if [[ ! -d "$lib_path" ]]; then
    echo "$name: stable path not found ($lib_path)"
    return
  fi
  
  local sub_commit=$(cd "$submodule_path" && git rev-parse HEAD 2>/dev/null)
  local lib_commit=$(git -C "$lib_path" rev-parse HEAD 2>/dev/null)
  
  if [[ "$sub_commit" == "$lib_commit" ]]; then
    echo "$name: up to date"
  else
    (
      cd "$submodule_path"
      git fetch origin &>/dev/null
      local ahead=$(git rev-list --count HEAD..origin/HEAD 2>/dev/null || echo "?")
      local behind=$(git rev-list --count origin/HEAD..HEAD 2>/dev/null || echo "?")
      echo "$name: behind $ahead commits (run: vnd update $name)"
    )
  fi
}

cmd_checkout() {
  local name="$1"
  local ref="$2"
  
  if [[ -z "$name" || -z "$ref" ]]; then
    echo "Error: name and ref required" >&2
    exit 1
  fi
  
  local submodule_path="${VENDOR_DIR}/${name}"
  (cd "$submodule_path" && git checkout "$ref")
  echo "Checked out $name to $ref"
}

cmd_ls() {
  git submodule status "$VENDOR_DIR"/* 2>/dev/null | while read -r line; do
    echo "$line"
  done
}

cmd_sync() {
  git submodule sync
  echo "Synced submodule URLs"
}

case "${1:-}" in
  init)     cmd_init ;;
  add)      cmd_add "$2" ;;
  rm)       cmd_rm "$2" ;;
  pull)     cmd_pull "$2" ;;
  update)   cmd_update "$2" ;;
  status)   cmd_status "$2" ;;
  checkout) cmd_checkout "$2" "$3" ;;
  ls)       cmd_ls ;;
  sync)     cmd_sync ;;
  -h|--help|help|"") usage ;;
  *)        echo "Unknown command: $1" >&2; usage; exit 1 ;;
esac
